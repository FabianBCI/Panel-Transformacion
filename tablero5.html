<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tablero de Seguimiento de Transformación - Hoja 2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .progress-bar-transition { transition: width 1s ease-in-out; }
        .modal-overlay { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease, opacity 0.3s ease; }
        .modal-hidden { opacity: 0; pointer-events: none; }
        .modal-hidden .modal-content { transform: scale(0.95); opacity: 0; }
        textarea:focus { outline: none; border-color: #3b82f6; ring: 2px; ring-color: #bfdbfe; }
        
        @keyframes pulse-success {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
        .save-pulse { animation: pulse-success 0.5s ease-in-out; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen">

    <div class="max-w-7xl mx-auto p-4 md:p-8">
        <!-- Header -->
        <header class="mb-8 flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div>
                <h1 class="text-3xl font-bold text-slate-800 flex items-center gap-3">
                    <i data-lucide="layout-dashboard" class="text-blue-600"></i>
                    Estado de Iniciativas (Hoja 2)
                </h1>
                <p class="text-slate-500 mt-1">Reporte detallado de transformación - Enero 2026</p>
            </div>
            
            <div id="filter-container" class="flex items-center gap-2 bg-white p-1 rounded-xl shadow-sm border border-slate-200 overflow-x-auto">
                <!-- Filtros dinámicos -->
            </div>
        </header>

        <!-- Stats Grid -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 flex items-center gap-5">
                <div class="bg-blue-50 p-4 rounded-xl text-blue-600">
                    <i data-lucide="bar-chart-3" class="w-8 h-8"></i>
                </div>
                <div>
                    <p class="text-sm font-medium text-slate-500 uppercase tracking-wider">Avance Promedio</p>
                    <div class="flex items-baseline gap-2">
                        <span id="stat-avg-progress" class="text-3xl font-bold">0%</span>
                    </div>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 flex items-center gap-5">
                <div class="bg-green-50 p-4 rounded-xl text-green-600">
                    <i data-lucide="check-circle-2" class="w-8 h-8"></i>
                </div>
                <div>
                    <p class="text-sm font-medium text-slate-500 uppercase tracking-wider">Completadas (100%)</p>
                    <p class="text-3xl font-bold"><span id="stat-completed">0</span> <span class="text-lg font-normal text-slate-400">/ <span id="stat-total">0</span></span></p>
                </div>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 flex items-center gap-5 text-slate-400" id="sync-status">
                <div class="bg-slate-50 p-4 rounded-xl">
                    <i data-lucide="database" class="w-8 h-8" id="sync-icon"></i>
                </div>
                <div>
                    <p class="text-sm font-medium uppercase tracking-wider">Almacenamiento</p>
                    <p class="text-lg font-bold" id="sync-text">Memoria Local</p>
                </div>
            </div>
        </div>

        <!-- Initiatives Grid -->
        <div id="initiatives-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Tarjetas dinámicas -->
        </div>

        <div id="empty-state" class="hidden bg-white p-20 rounded-2xl shadow-sm border border-slate-200 text-center">
            <i data-lucide="filter" class="mx-auto text-slate-300 mb-4 w-12 h-12"></i>
            <h3 class="text-xl font-bold text-slate-700">No hay iniciativas en esta categoría</h3>
            <p class="text-slate-500">Prueba seleccionando otro filtro.</p>
        </div>

        <footer class="mt-12 text-center text-slate-400 text-sm">
            Fuente: Drive "Estado iniciativas transformación" • Datos exclusivos Hoja 2
        </footer>
    </div>

    <!-- Modal Structure -->
    <div id="detail-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm modal-overlay modal-hidden">
        <div class="bg-white w-full max-w-2xl rounded-3xl shadow-2xl overflow-hidden modal-content">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <div id="modal-badge-container" class="flex gap-2"></div>
                <button onclick="closeModal()" class="p-2 hover:bg-slate-200 rounded-full transition-colors">
                    <i data-lucide="x" class="w-6 h-6 text-slate-500"></i>
                </button>
            </div>
            <div class="p-8 max-h-[80vh] overflow-y-auto">
                <h2 id="modal-title" class="text-3xl font-bold text-slate-800 mb-4"></h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                    <div>
                        <h4 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-3 text-blue-600">Descripción Detallada</h4>
                        <p id="modal-description" class="text-slate-600 leading-relaxed text-sm"></p>
                    </div>
                    <div class="space-y-6">
                        <div>
                            <h4 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-3">Estado de Avance</h4>
                            <div class="flex items-center gap-3 mb-2">
                                <div class="flex-grow h-3 bg-slate-100 rounded-full overflow-hidden">
                                    <div id="modal-progress-bar" class="h-full bg-blue-600 transition-all duration-700"></div>
                                </div>
                                <span id="modal-progress-text" class="font-bold text-slate-700"></span>
                            </div>
                            <p id="modal-status-label" class="text-sm font-medium text-slate-500"></p>
                        </div>
                        <div>
                            <h4 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-3">Pilar Estratégico</h4>
                            <div id="modal-pilar" class="flex items-center gap-2 text-slate-700 font-medium"></div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 gap-6 mb-8">
                    <div class="bg-blue-50 rounded-2xl p-6 border border-blue-100">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="p-2 bg-blue-600 rounded-lg text-white">
                                <i data-lucide="rocket" class="w-5 h-5"></i>
                            </div>
                            <h4 class="font-bold text-blue-900 tracking-tight">Próximos Pasos</h4>
                        </div>
                        <p id="modal-next-step" class="text-blue-800 text-sm font-medium"></p>
                    </div>

                    <div class="bg-amber-50 rounded-2xl p-6 border border-amber-100">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-3">
                                <div class="p-2 bg-amber-500 rounded-lg text-white">
                                    <i data-lucide="sticky-note" class="w-5 h-5"></i>
                                </div>
                                <h4 class="font-bold text-amber-900 tracking-tight">Anotaciones y Notas</h4>
                            </div>
                            <div id="save-indicator" class="text-[10px] font-bold text-amber-600 uppercase tracking-wider hidden">
                                ¡Guardado!
                            </div>
                        </div>
                        <textarea 
                            id="modal-notes" 
                            class="w-full h-32 p-4 rounded-xl border-amber-200 bg-white text-sm text-slate-700 placeholder-amber-300 resize-none transition-all shadow-inner focus:border-amber-400 focus:ring-1 focus:ring-amber-200"
                            placeholder="Escribe aquí tus notas..."
                        ></textarea>
                    </div>
                </div>
            </div>
            <div class="p-6 bg-slate-50 border-t border-slate-100 flex justify-end gap-3">
                <button onclick="closeModal()" class="px-6 py-2 bg-white border border-slate-200 text-slate-600 font-bold rounded-xl hover:bg-slate-50 transition-all">
                    Cerrar
                </button>
                <button id="btn-save" onclick="saveNotes()" class="px-6 py-2 bg-slate-800 text-white font-bold rounded-xl hover:bg-slate-900 transition-all shadow-md flex items-center gap-2">
                    <i data-lucide="save" class="w-4 h-4"></i>
                    Guardar Notas
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        let db, auth, user;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'transformacion-dashboard';
        
        // Datos base cargados de la Hoja 2
        let initiatives = [
            { id: 1, category: 'Automatización - IA', pilar: 'Experiencia - Eficiencia', name: 'AgentForce - Salesforce', status: 'Piloto (500 colab.)', progress: 100, description: 'Implementación estratégica de agentes inteligentes de Salesforce.', fullDescription: 'Este proyecto representa el pilar de eficiencia tecnológica más robusto actualmente. Se ha desplegado exitosamente un piloto con 500 colaboradores.', nextStep: 'Ampliar a 5000 colaboradores y activar nuevo flujo de tarjetas.', priority: 'Alta', notes: '' },
            { id: 2, category: 'Automatización - IA', pilar: 'Experiencia - Eficiencia', name: 'Predictive routing - Genesys', status: 'Test Activado (08-01)', progress: 100, description: 'Enrutamiento inteligente basado en perfiles.', fullDescription: 'Algoritmos predictivos para dirigir llamadas al agente más calificado.', nextStep: 'Revisión final de resultados de contactabilidad.', priority: 'Media', notes: '' },
            { id: 3, category: 'Automatización - IA', pilar: 'Experiencia - Eficiencia', name: 'Supervisor copilot - Genesys', status: 'Plantilla Configurada', progress: 90, description: 'Asistencia en tiempo real para supervisores.', fullDescription: 'Insights accionables para supervisores durante la operación activa.', nextStep: 'Coordinar pruebas con el área de calidad-torre.', priority: 'Alta', notes: '' },
            { id: 4, category: 'Automatización - IA', pilar: 'Experiencia - Eficiencia', name: 'Agent Copilot - Resumen', status: 'Activo (4 agentes)', progress: 100, description: 'Generación automática de resúmenes post-interacción.', fullDescription: 'Uso de LLMs para ahorrar tiempo en tipificación y cierre de llamadas.', nextStep: 'Monitorear métricas de eficiencia en resumen.', priority: 'Media', notes: '' },
            { id: 5, category: 'Automatización - IA', pilar: 'Experiencia - Eficiencia', name: 'Sugerencia de Tipificación', status: 'En espera', progress: 40, description: 'Módulo inteligente que sugiere motivos de contacto.', fullDescription: 'Análisis de transcripción para sugerir categorías de cierre automáticamente.', nextStep: 'Activación prevista en 2 semanas.', priority: 'Media', notes: '' },
            { id: 6, category: 'Estructura y Personas', pilar: 'Talento', name: 'Iniciativas Pablo B.', status: 'En Cocreación', progress: 10, description: 'Marco de trabajo y dashboard de seguimiento estratégico.', fullDescription: 'Modelo de gobierno para las iniciativas lideradas por Pablo B.', nextStep: 'Sesión de cocreación: martes 27-01.', priority: 'Baja', notes: '' },
            { id: 7, category: 'Automatización - IA', pilar: 'Experiencia - Eficiencia', name: 'Resumen interacción', status: 'Pendiente', progress: 0, description: 'Estandarización transversal de resúmenes.', fullDescription: 'Pendiente de definición técnica para extender capacidades a todos los canales.', nextStep: 'Definir alcance inicial.', priority: 'Baja', notes: '' },
            { id: 8, category: 'Automatización - IA', pilar: 'Experiencia - Eficiencia', name: 'Herramienta calidad', status: 'Pendiente', progress: 0, description: 'Auditoría de calidad asistida por IA.', fullDescription: 'Auditoría del 100% de las interacciones mediante tecnología.', nextStep: 'Evaluación de proveedores.', priority: 'Baja', notes: '' },
            { id: 9, category: 'Modelo Atencional', pilar: 'Experiencia - Eficiencia', name: 'Migración Chat Meau', status: 'En Preparación', progress: 30, description: 'Cambio de motor de chat para iOS.', fullDescription: 'Infraestructura mejorada para mayor estabilidad en Apple.', nextStep: '01-04 Migración. Cerrar apoyos con Atento.', priority: 'Alta', notes: '' },
            { id: 10, category: 'Estructura y Personas', pilar: 'Talento', name: 'Gestión del cambio', status: 'Diseño', progress: 20, description: 'Plan de acompañamiento para adopción de IA.', fullDescription: 'Mitigación de resistencia ante la llegada masiva de Copilots.', nextStep: 'Finalizar etapa de diseño estratégico.', priority: 'Media', notes: '' },
            { id: 11, category: 'Estructura y Personas', pilar: 'Talento', name: 'GGPP ahorro vacantes', status: 'Pendiente', progress: 5, description: 'Optimización de estructura organizacional.', fullDescription: 'Análisis del impacto de automatizaciones en el headcount.', nextStep: 'Recibir resumen de Gabi.', priority: 'Media', notes: '' },
            { id: 12, category: 'Monetización', pilar: 'Ingresos', name: 'Piloto venta multiproducto', status: 'En diseño', progress: 10, description: 'Venta cruzada en canales de servicio.', fullDescription: 'Convertir canales de atención en centros de ingresos.', nextStep: 'Definir flujos de venta digitales.', priority: 'Alta', notes: '' }
        ];

        let currentFilter = 'Todas';
        let currentlyEditingId = null;

        // --- PERSISTENCIA LOCAL (Para tu archivo de Block de Notas) ---
        const loadLocalData = () => {
            const saved = localStorage.getItem('dashboard_transformacion_notas');
            if (saved) {
                const notesObj = JSON.parse(saved);
                initiatives.forEach(item => {
                    if (notesObj[item.id]) {
                        item.notes = notesObj[item.id];
                    }
                });
            }
        };

        const saveToLocal = () => {
            const notesObj = {};
            initiatives.forEach(item => {
                if (item.notes) notesObj[item.id] = item.notes;
            });
            localStorage.setItem('dashboard_transformacion_notas', JSON.stringify(notesObj));
        };

        const initialSetup = () => {
            loadLocalData(); // Cargar primero lo guardado en el navegador
            renderFilters();
            renderInitiatives();
            lucide.createIcons();
        };

        // --- Funciones de Interfaz ---
        window.setFilter = (cat) => {
            currentFilter = cat;
            renderFilters();
            renderInitiatives();
        };

        window.openDetail = (id) => {
            const item = initiatives.find(i => i.id === id);
            if (!item) return;
            currentlyEditingId = id;
            document.getElementById('modal-title').innerText = item.name;
            document.getElementById('modal-description').innerText = item.fullDescription;
            document.getElementById('modal-next-step').innerText = item.nextStep;
            document.getElementById('modal-progress-text').innerText = `${item.progress}%`;
            document.getElementById('modal-progress-bar').style.width = `${item.progress}%`;
            document.getElementById('modal-status-label').innerText = `Estado: ${item.status}`;
            document.getElementById('modal-notes').value = item.notes || '';
            document.getElementById('modal-pilar').innerText = item.pilar;
            
            const badgeContainer = document.getElementById('modal-badge-container');
            badgeContainer.innerHTML = `<span class="px-3 py-1 bg-slate-100 text-slate-500 text-[10px] font-bold rounded-full border uppercase">${item.category}</span>`;
            
            document.getElementById('detail-modal').classList.remove('modal-hidden');
            lucide.createIcons();
        };

        window.closeModal = () => {
            document.getElementById('detail-modal').classList.add('modal-hidden');
            currentlyEditingId = null;
        };

        window.saveNotes = async () => {
            if (currentlyEditingId === null) return;
            const notesValue = document.getElementById('modal-notes').value;
            const index = initiatives.findIndex(i => i.id === currentlyEditingId);
            
            if (index !== -1) {
                initiatives[index].notes = notesValue;
                saveToLocal(); // Guardar en el navegador inmediatamente
                renderInitiatives();
            }

            // Sincronizar con la nube si estamos en el entorno AI
            if (user && db) {
                try {
                    const noteDoc = doc(db, 'artifacts', appId, 'public', 'data', 'notes', currentlyEditingId.toString());
                    await setDoc(noteDoc, { text: notesValue, updatedAt: new Date().toISOString() });
                    showSaveSuccess();
                } catch (e) { console.error(e); }
            } else {
                showSaveSuccess(); // Mostrar éxito aunque sea local
            }
            closeModal();
        };

        function showSaveSuccess() {
            const indicator = document.getElementById('save-indicator');
            if (indicator) {
                indicator.classList.remove('hidden');
                setTimeout(() => indicator.classList.add('hidden'), 2000);
            }
        }

        function getStatusClasses(status) {
            if (status.includes('Piloto') || status.includes('Activo') || status.includes('Test')) return 'bg-green-100 text-green-700 border-green-200';
            if (status.includes('Diseño') || status.includes('Preparación') || status.includes('Configurada')) return 'bg-blue-100 text-blue-700 border-blue-200';
            return 'bg-slate-100 text-slate-500 border-slate-200';
        }

        function renderStats() {
            const total = initiatives.length;
            const completed = initiatives.filter(i => i.progress === 100).length;
            const avgProgress = Math.round(initiatives.reduce((acc, curr) => acc + curr.progress, 0) / total);
            document.getElementById('stat-avg-progress').innerText = `${avgProgress}%`;
            document.getElementById('stat-completed').innerText = completed;
            document.getElementById('stat-total').innerText = total;
        }

        function renderFilters() {
            const categories = ['Todas', ...new Set(initiatives.map(i => i.category))];
            const container = document.getElementById('filter-container');
            if (!container) return;
            container.innerHTML = categories.map(cat => `
                <button onclick="setFilter('${cat}')" class="px-4 py-2 rounded-lg text-sm font-medium transition-all whitespace-nowrap ${currentFilter === cat ? 'bg-blue-600 text-white shadow-md' : 'text-slate-600 hover:bg-slate-100'}">
                    ${cat}
                </button>
            `).join('');
        }

        function renderInitiatives() {
            const grid = document.getElementById('initiatives-grid');
            if (!grid) return;
            const filtered = currentFilter === 'Todas' ? initiatives : initiatives.filter(i => i.category === currentFilter);
            grid.innerHTML = filtered.map(item => `
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 hover:shadow-md transition-shadow flex flex-col overflow-hidden relative">
                    ${item.notes ? `<div class="absolute top-2 right-2 bg-amber-100 text-amber-600 p-1.5 rounded-lg border border-amber-200"><i data-lucide="sticky-note" class="w-3.5 h-3.5"></i></div>` : ''}
                    <div class="p-5 flex-grow">
                        <div class="flex justify-between items-start mb-4">
                            <span class="text-[10px] font-bold uppercase text-slate-500">${item.category}</span>
                            <span class="text-[10px] font-bold px-2 py-1 rounded-full border ${getStatusClasses(item.status)}">${item.status}</span>
                        </div>
                        <h3 class="text-lg font-bold text-slate-800 mb-2 leading-tight">${item.name}</h3>
                        <p class="text-sm text-slate-500 mb-4 line-clamp-2">${item.description}</p>
                        <div class="w-full bg-slate-100 rounded-full h-1.5 overflow-hidden mb-4">
                            <div class="h-full bg-blue-500 progress-bar-transition" style="width: ${item.progress}%"></div>
                        </div>
                        <div class="bg-slate-50 rounded-xl p-3 border border-slate-100">
                            <p class="text-[9px] font-bold text-slate-400 uppercase">Siguiente paso</p>
                            <p class="text-xs text-slate-700 font-medium truncate">${item.nextStep}</p>
                        </div>
                    </div>
                    <div class="px-5 py-3 bg-slate-50/50 border-t border-slate-100 flex items-center justify-between">
                        <span class="text-xs font-medium text-slate-500">Prio: ${item.priority}</span>
                        <button onclick="openDetail(${item.id})" class="text-blue-600 hover:text-blue-700 text-xs font-bold uppercase flex items-center gap-1">
                            Ver más <i data-lucide="chevron-right" class="w-3 h-3"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
            renderStats();
        }

        // --- Firebase Core (Solo funciona en la plataforma) ---
        const startFirebase = async () => {
            try {
                if (typeof __firebase_config === 'undefined') return;
                const config = JSON.parse(__firebase_config);
                const app = initializeApp(config);
                auth = getAuth(app);
                db = getFirestore(app);
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                onAuthStateChanged(auth, (u) => {
                    user = u;
                    if (user) {
                        document.getElementById('sync-text').innerText = "Nube Conectada";
                        document.getElementById('sync-icon').classList.add('text-blue-600');
                        const notesCol = collection(db, 'artifacts', appId, 'public', 'data', 'notes');
                        onSnapshot(notesCol, (snapshot) => {
                            snapshot.forEach((doc) => {
                                const idx = initiatives.findIndex(i => i.id === parseInt(doc.id));
                                if (idx !== -1) initiatives[idx].notes = doc.data().text || '';
                            });
                            renderInitiatives();
                        });
                    }
                });
            } catch (e) { console.warn("Modo offline activado"); }
        };

        initialSetup();
        startFirebase();
        document.getElementById('detail-modal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('detail-modal')) closeModal();
        });
    </script>
</body>
</html>