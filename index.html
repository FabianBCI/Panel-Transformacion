<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tablero de Seguimiento BCI - Compartible</title>
    <!-- Tailwind CSS para diseño moderno -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide para iconos -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .progress-bar-transition { transition: width 0.8s ease-in-out; }
        .modal-overlay { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease, opacity 0.3s ease; }
        .modal-hidden { opacity: 0; pointer-events: none; }
        .modal-hidden .modal-content { transform: scale(0.95); opacity: 0; }
        textarea:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2); }
        .card-shadow:hover { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen">

    <div class="max-w-7xl mx-auto p-4 md:p-8">
        <!-- Encabezado con botones de acción -->
        <header class="mb-10 flex flex-col lg:flex-row lg:items-center justify-between gap-6">
            <div>
                <h1 class="text-3xl font-extrabold text-slate-900 flex items-center gap-3">
                    <i data-lucide="layout-dashboard" class="text-blue-600 w-8 h-8"></i>
                    Estado de Iniciativas
                </h1>
                <p class="text-slate-500 mt-1 font-medium">Transformación BCI • Hoja 2 • Seguimiento Enero 2026</p>
            </div>
            
            <div class="flex flex-wrap items-center gap-3">
                <!-- Contenedor de filtros dinámicos -->
                <div id="filter-container" class="flex items-center gap-2 bg-white p-1 rounded-2xl shadow-sm border border-slate-200"></div>
                
                <div class="flex gap-2">
                    <!-- Botón para generar el link con notas incluidas -->
                    <button onclick="generateShareLink()" class="flex items-center gap-2 px-5 py-2.5 bg-indigo-600 rounded-xl text-xs font-bold text-white hover:bg-indigo-700 transition-all shadow-lg active:scale-95">
                        <i data-lucide="share-2" class="w-4 h-4"></i> Generar Link Compartible
                    </button>
                    <!-- Botón para descargar respaldo -->
                    <button onclick="exportData()" class="flex items-center gap-2 px-4 py-2.5 bg-white border border-slate-200 rounded-xl text-xs font-bold text-slate-600 hover:bg-slate-50 transition-all">
                        <i data-lucide="download" class="w-4 h-4"></i> Exportar
                    </button>
                </div>
            </div>
        </header>

        <!-- Panel de Estadísticas Rápidas -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200 flex items-center gap-5">
                <div class="bg-blue-50 p-4 rounded-2xl text-blue-600">
                    <i data-lucide="bar-chart-3" class="w-8 h-8"></i>
                </div>
                <div>
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">Avance Promedio</p>
                    <span id="stat-avg-progress" class="text-3xl font-bold text-slate-800">0%</span>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200 flex items-center gap-5">
                <div class="bg-green-50 p-4 rounded-2xl text-green-600">
                    <i data-lucide="check-circle-2" class="w-8 h-8"></i>
                </div>
                <div>
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">Completadas</p>
                    <p class="text-3xl font-bold text-slate-800"><span id="stat-completed">0</span> <span class="text-lg font-normal text-slate-400">/ <span id="stat-total">0</span></span></p>
                </div>
            </div>

            <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200 flex items-center gap-5">
                <div class="p-4 rounded-2xl bg-indigo-50 text-indigo-600">
                    <i data-lucide="database" class="w-8 h-8"></i>
                </div>
                <div>
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">Estado de Datos</p>
                    <p class="text-lg font-bold text-slate-700" id="sync-text">Memoria Local</p>
                </div>
            </div>
        </div>

        <!-- Rejilla de Tarjetas de Iniciativas -->
        <div id="initiatives-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <!-- Las tarjetas se generan dinámicamente -->
        </div>

        <!-- Estado vacío -->
        <div id="empty-state" class="hidden bg-white p-20 rounded-3xl shadow-sm border border-slate-200 text-center">
            <i data-lucide="search-x" class="mx-auto text-slate-300 mb-4 w-16 h-16"></i>
            <h3 class="text-xl font-bold text-slate-700">No hay iniciativas que coincidan</h3>
        </div>

        <footer class="mt-16 text-center text-slate-400 text-sm border-t border-slate-200 pt-8">
            Fuente: Hoja 2 del archivo "Estado iniciativas transformación" • Banco BCI 2026
        </footer>
    </div>

    <!-- Modal de Detalles y Notas -->
    <div id="detail-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm modal-overlay modal-hidden">
        <div class="bg-white w-full max-w-2xl rounded-[2.5rem] shadow-2xl overflow-hidden modal-content">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <div id="modal-badge-container" class="flex gap-2"></div>
                <button onclick="closeModal()" class="p-2 hover:bg-slate-200 rounded-full transition-colors">
                    <i data-lucide="x" class="w-6 h-6 text-slate-500"></i>
                </button>
            </div>
            <div class="p-10 max-h-[80vh] overflow-y-auto">
                <h2 id="modal-title" class="text-3xl font-bold text-slate-900 mb-6"></h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-10 mb-10">
                    <div class="space-y-6">
                        <div>
                            <h4 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">Descripción General</h4>
                            <p id="modal-description" class="text-slate-600 text-sm leading-relaxed"></p>
                        </div>
                        <div>
                            <h4 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">Pilar Estratégico</h4>
                            <p id="modal-pilar" class="text-sm font-semibold text-slate-800 flex items-center gap-2">
                                <i data-lucide="target" class="w-4 h-4 text-blue-500"></i>
                                <span id="modal-pilar-text"></span>
                            </p>
                        </div>
                    </div>
                    <div class="space-y-8">
                        <div>
                            <h4 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-3">Progreso del Proyecto</h4>
                            <div class="flex items-center gap-4">
                                <div class="flex-grow h-4 bg-slate-100 rounded-full overflow-hidden border border-slate-200">
                                    <div id="modal-progress-bar" class="h-full bg-blue-600 transition-all duration-1000"></div>
                                </div>
                                <span id="modal-progress-text" class="font-extrabold text-slate-700 text-base"></span>
                            </div>
                        </div>
                        <div class="bg-blue-50 p-5 rounded-2xl border border-blue-100">
                            <h4 class="text-[10px] font-bold text-blue-500 uppercase mb-1 tracking-widest">Siguiente Hito</h4>
                            <p id="modal-next-step" class="text-blue-900 text-sm font-bold leading-snug"></p>
                        </div>
                    </div>
                </div>

                <!-- Sección de Anotaciones -->
                <div class="bg-amber-50 rounded-3xl p-8 border border-amber-100 shadow-inner">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <div class="p-2.5 bg-amber-500 rounded-xl text-white shadow-md shadow-amber-200">
                                <i data-lucide="sticky-note" class="w-5 h-5"></i>
                            </div>
                            <h4 class="font-bold text-amber-900 text-lg">Anotaciones del Equipo</h4>
                        </div>
                        <div id="save-indicator" class="text-[10px] font-bold text-amber-600 uppercase tracking-widest hidden">¡Cambios Guardados!</div>
                    </div>
                    <textarea 
                        id="modal-notes" 
                        class="w-full h-40 p-5 rounded-2xl border-amber-200 bg-white text-sm text-slate-700 placeholder-amber-300 resize-none transition-all shadow-sm"
                        placeholder="Escribe aquí notas, riesgos o comentarios. Estos se incluirán al generar un link compartido..."
                    ></textarea>
                </div>
            </div>
            <div class="p-8 bg-slate-50 border-t border-slate-100 flex justify-end gap-4">
                <button onclick="closeModal()" class="px-8 py-3 bg-white border border-slate-200 text-slate-600 font-bold rounded-2xl hover:bg-slate-100 transition-all">Cancelar</button>
                <button onclick="saveNotes()" class="px-8 py-3 bg-slate-900 text-white font-bold rounded-2xl hover:bg-black shadow-xl flex items-center gap-2 transition-all active:scale-95">
                    <i data-lucide="save" class="w-4 h-4"></i> Guardar Notas
                </button>
            </div>
        </div>
    </div>

    <script>
        // Datos maestros de la HOJA 2
        let initiatives = [
            { id: 1, category: 'Automatización - IA', pilar: 'Experiencia - Eficiencia', name: 'AgentForce - Salesforce', status: 'Piloto (500 colab.)', progress: 100, description: 'Implementación estratégica de agentes inteligentes de Salesforce.', fullDescription: 'Despliegue exitoso con 500 colaboradores para automatizar consultas frecuentes. Tecnología nativa integrada con perfiles de cliente.', nextStep: 'Ampliar a 5000 colaboradores y nuevo flujo tarjetas.', priority: 'Alta', notes: '' },
            { id: 2, category: 'Automatización - IA', pilar: 'Experiencia - Eficiencia', name: 'Predictive routing - Genesys', status: 'Test Activado', progress: 100, description: 'Enrutamiento basado en perfil predictivo.', fullDescription: 'Algoritmos predictivos para dirigir llamadas a los agentes más aptos según comportamiento previo.', nextStep: 'Revisión final de KPIs de contactabilidad.', priority: 'Media', notes: '' },
            { id: 3, category: 'Automatización - IA', pilar: 'Experiencia - Eficiencia', name: 'Supervisor copilot - Genesys', status: 'Configurada', progress: 90, description: 'Asistencia en tiempo real para supervisores.', fullDescription: 'Insights accionables y detección de sentimientos en interacciones en vivo para la torre operativa.', nextStep: 'Coordinar pruebas con el área de calidad.', priority: 'Alta', notes: '' },
            { id: 4, category: 'Automatización - IA', pilar: 'Experiencia - Eficiencia', name: 'Agent Copilot - Resumen', status: 'Activo', progress: 100, description: 'Resumen automático post-interacción.', fullDescription: 'Generación automática de minutas de llamada mediante LLMs, ahorrando ~60 seg por interacción.', nextStep: 'Monitorear métricas de eficiencia y ahorro.', priority: 'Media', notes: '' },
            { id: 5, category: 'Automatización - IA', pilar: 'Experiencia - Eficiencia', name: 'Sugerencia de Tipificación', status: 'En espera', progress: 40, description: 'IA que sugiere el motivo de cierre.', fullDescription: 'Análisis de transcripción para predecir la tipificación correcta, reduciendo errores humanos.', nextStep: 'Activación prevista en un plazo de 2 semanas.', priority: 'Media', notes: '' },
            { id: 6, category: 'Estructura y Personas', pilar: 'Talento', name: 'Iniciativas Pablo B.', status: 'Cocreación', progress: 10, description: 'Panel de seguimiento estratégico.', fullDescription: 'Modelo de gobierno y visualización de progreso para iniciativas de talento lideradas por Pablo B.', nextStep: 'Sesión de cocreación: martes 27 de enero.', priority: 'Baixa', notes: '' },
            { id: 7, category: 'Automatización - IA', pilar: 'Experiencia - Eficiencia', name: 'Resumen interacción', status: 'Pendiente', progress: 0, description: 'Estandarización transversal de resúmenes.', fullDescription: 'Extender la capacidad de resumen automático a todos los puntos de contacto digitales.', nextStep: 'Definir alcance técnico inicial.', priority: 'Baixa', notes: '' },
            { id: 8, category: 'Automatización - IA', pilar: 'Experiencia - Eficiencia', name: 'Herramienta calidad', status: 'Pendiente', progress: 0, description: 'Auditoría asistida por IA.', fullDescription: 'Proyecto para auditar el 100% de las conversaciones buscando patrones de cumplimiento.', nextStep: 'Evaluación de proveedores y benchmarking.', priority: 'Baixa', notes: '' },
            { id: 9, category: 'Modelo Atencional', pilar: 'Experiencia - Eficiencia', name: 'Migración Chat Meau', status: 'Preparación', progress: 30, description: 'Nuevo motor de chat para iOS.', fullDescription: 'Actualización de infraestructura para mejorar estabilidad en dispositivos Apple.', nextStep: 'Hito de migración: 01 de Abril.', priority: 'Alta', notes: '' },
            { id: 10, category: 'Estructura y Personas', pilar: 'Talento', name: 'Gestión del cambio', status: 'Diseño', progress: 20, description: 'Plan de adopción para IA.', fullDescription: 'Estrategia para mitigar resistencia ante la llegada masiva de copilotos y asistentes.', nextStep: 'Finalizar etapa de diseño estratégico.', priority: 'Media', notes: '' },
            { id: 11, category: 'Estructura y Personas', pilar: 'Talento', name: 'GGPP ahorro vacantes', status: 'Pendiente', progress: 5, description: 'Optimización organizacional.', fullDescription: 'Gestión del ahorro presupuestario generado por eficiencias en vacantes.', nextStep: 'Recibir resumen procesado de Gabi.', priority: 'Media', notes: '' },
            { id: 12, category: 'Monetización', pilar: 'Ingresos', name: 'Piloto venta multiproducto', status: 'En diseño', progress: 10, description: 'Venta cruzada en canales de servicio.', fullDescription: 'Habilitar sugerencias comerciales inteligentes durante la atención al cliente.', nextStep: 'Definir flujos de venta digitales.', priority: 'Alta', notes: '' }
        ];

        let currentFilter = 'Todas';
        let currentlyEditingId = null;

        // --- LÓGICA DE COMPARTIR POR URL ---
        const loadFromUrl = () => {
            const params = new URLSearchParams(window.location.search);
            const dataParam = params.get('data');
            if (dataParam) {
                try {
                    // Decodificamos el JSON de la URL
                    const decodedData = JSON.parse(decodeURIComponent(escape(atob(dataParam))));
                    initiatives.forEach(item => {
                        if (decodedData[item.id]) item.notes = decodedData[item.id];
                    });
                    document.getElementById('sync-text').innerText = "Datos vía Link";
                    return true;
                } catch (e) { console.error("Error al decodificar URL", e); }
            }
            return false;
        };

        window.generateShareLink = () => {
            const notesToShare = {};
            initiatives.forEach(item => { if (item.notes) notesToShare[item.id] = item.notes; });
            
            // Codificamos los datos en formato Base64 para que quepan en la URL
            const encoded = btoa(unescape(encodeURIComponent(JSON.stringify(notesToShare))));
            const shareUrl = `${window.location.origin}${window.location.pathname}?data=${encoded}`;
            
            // Copiamos al portapapeles
            const dummy = document.createElement('textarea');
            dummy.value = shareUrl;
            document.body.appendChild(dummy);
            dummy.select();
            document.execCommand('copy');
            document.body.removeChild(dummy);
            
            alert("¡Link Compartible Generado!\n\nSe ha copiado a tu portapapeles. Envía este enlace a tus colegas para que vean tus anotaciones.");
        };

        // --- PERSISTENCIA LOCAL ---
        const saveLocal = () => {
            const localObj = {};
            initiatives.forEach(item => { if (item.notes) localObj[item.id] = item.notes; });
            localStorage.setItem('bci_notes_v5', JSON.stringify(localObj));
        };

        const loadLocal = () => {
            const saved = localStorage.getItem('bci_notes_v5');
            if (saved) {
                const parsed = JSON.parse(saved);
                initiatives.forEach(item => { if (parsed[item.id]) item.notes = parsed[item.id]; });
            }
        };

        // --- FUNCIONES UI ---
        window.saveNotes = () => {
            if (currentlyEditingId === null) return;
            const val = document.getElementById('modal-notes').value;
            const idx = initiatives.findIndex(i => i.id === currentlyEditingId);
            
            initiatives[idx].notes = val;
            saveLocal();
            renderInitiatives();
            
            const indicator = document.getElementById('save-indicator');
            indicator.classList.remove('hidden');
            setTimeout(() => indicator.classList.add('hidden'), 2000);
            closeModal();
        };

        window.openDetail = (id) => {
            const item = initiatives.find(i => i.id === id);
            currentlyEditingId = id;
            
            document.getElementById('modal-title').innerText = item.name;
            document.getElementById('modal-description').innerText = item.fullDescription;
            document.getElementById('modal-next-step').innerText = item.nextStep;
            document.getElementById('modal-progress-text').innerText = `${item.progress}%`;
            document.getElementById('modal-progress-bar').style.width = `${item.progress}%`;
            document.getElementById('modal-pilar-text').innerText = item.pilar;
            document.getElementById('modal-notes').value = item.notes || '';
            
            document.getElementById('modal-badge-container').innerHTML = `
                <span class="px-3 py-1 bg-slate-100 text-slate-500 text-[10px] font-extrabold rounded-full border uppercase tracking-wider">${item.category}</span>
                <span class="px-3 py-1 bg-blue-50 text-blue-600 text-[10px] font-extrabold rounded-full border border-blue-100 uppercase tracking-wider">${item.status}</span>
            `;
            
            document.getElementById('detail-modal').classList.remove('modal-hidden');
            lucide.createIcons();
        };

        window.closeModal = () => {
            document.getElementById('detail-modal').classList.add('modal-hidden');
            currentlyEditingId = null;
        };

        window.setFilter = (cat) => {
            currentFilter = cat;
            renderFilters();
            renderInitiatives();
        };

        window.exportData = () => {
            const data = {};
            initiatives.forEach(i => { if (i.notes) data[i.id] = i.notes; });
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `notas_bci_respaldo.json`;
            a.click();
        };

        // --- RENDERIZADORES ---
        function renderFilters() {
            const cats = ['Todas', ...new Set(initiatives.map(i => i.category))];
            const container = document.getElementById('filter-container');
            container.innerHTML = cats.map(c => `
                <button onclick="setFilter('${c}')" class="px-4 py-2 rounded-xl text-xs font-bold transition-all ${currentFilter === c ? 'bg-blue-600 text-white shadow-md' : 'text-slate-500 hover:bg-slate-100'}">
                    ${c}
                </button>
            `).join('');
        }

        function renderInitiatives() {
            const grid = document.getElementById('initiatives-grid');
            const empty = document.getElementById('empty-state');
            const filtered = currentFilter === 'Todas' ? initiatives : initiatives.filter(i => i.category === currentFilter);
            
            if (filtered.length === 0) {
                grid.classList.add('hidden');
                empty.classList.remove('hidden');
            } else {
                grid.classList.remove('hidden');
                empty.classList.add('hidden');
                
                grid.innerHTML = filtered.map(item => `
                    <div class="bg-white rounded-[2rem] shadow-sm border border-slate-200 transition-all flex flex-col relative overflow-hidden card-shadow group">
                        ${item.notes ? `
                            <div class="absolute top-4 right-4 bg-amber-100 text-amber-600 p-2 rounded-xl border border-amber-200 animate-pulse shadow-sm">
                                <i data-lucide="sticky-note" class="w-4 h-4"></i>
                            </div>
                        ` : ''}
                        
                        <div class="p-7 flex-grow">
                            <div class="flex justify-between items-start mb-5">
                                <span class="text-[10px] font-extrabold uppercase text-slate-400 tracking-[0.1em]">${item.category}</span>
                                <span class="text-[10px] font-extrabold px-3 py-1 rounded-full border ${item.progress === 100 ? 'bg-green-50 text-green-600 border-green-100' : 'bg-blue-50 text-blue-600 border-blue-100'} uppercase tracking-wider">${item.status}</span>
                            </div>
                            
                            <h3 class="text-xl font-extrabold text-slate-900 mb-3 leading-tight group-hover:text-blue-600 transition-colors">${item.name}</h3>
                            <p class="text-sm text-slate-500 mb-6 line-clamp-2 leading-relaxed font-medium">${item.description}</p>
                            
                            <div class="mb-2 flex justify-between items-center">
                                <span class="text-[10px] font-bold text-slate-400 uppercase">Progreso</span>
                                <span class="text-xs font-black text-slate-700">${item.progress}%</span>
                            </div>
                            <div class="w-full bg-slate-100 rounded-full h-2 overflow-hidden border border-slate-100 mb-6">
                                <div class="h-full bg-blue-600 progress-bar-transition" style="width: ${item.progress}%"></div>
                            </div>
                        </div>
                        
                        <div class="px-7 py-5 bg-slate-50 border-t border-slate-100 flex items-center justify-between">
                            <div class="flex items-center gap-1.5">
                                <span class="w-2 h-2 rounded-full ${item.priority === 'Alta' ? 'bg-red-500' : 'bg-orange-400'}"></span>
                                <span class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">${item.priority}</span>
                            </div>
                            <button onclick="openDetail(${item.id})" class="text-blue-600 font-extrabold uppercase text-[10px] flex items-center gap-1 hover:gap-2 transition-all">
                                Ver Detalles <i data-lucide="chevron-right" class="w-3.5 h-3.5"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            }
            
            lucide.createIcons();
            updateStats();
        }

        function updateStats() {
            const total = initiatives.length;
            const comp = initiatives.filter(i => i.progress === 100).length;
            const avg = Math.round(initiatives.reduce((acc, curr) => acc + curr.progress, 0) / total);
            
            document.getElementById('stat-avg-progress').innerText = `${avg}%`;
            document.getElementById('stat-completed').innerText = comp;
            document.getElementById('stat-total').innerText = total;
        }

        // --- INICIO ---
        const init = () => {
            const hasUrlData = loadFromUrl();
            if (!hasUrlData) loadLocal();
            
            renderFilters();
            renderInitiatives();
        };

        window.onload = init;
        document.getElementById('detail-modal').addEventListener('click', (e) => { if (e.target.id === 'detail-modal') closeModal(); });
    </script>
</body>
</html>
